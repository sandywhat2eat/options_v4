# Portfolio Allocator - Complete Logic Documentation

## Overview

The Portfolio Allocator is a sophisticated system that filters strategies generated by main.py from 400+ down to 15-20 strategies for execution. It uses industry weights, market conditions, and strategy scores to prioritize which strategies should be executed.

## Core Workflow

### Phase 1: Data Collection
The allocator collects three key data sources:

1. **Industry Allocations** - From `industry_allocations_current` table
2. **Market Conditions** - NIFTY direction + VIX level + PCR sentiment
3. **Available Strategies** - From strategies table generated by main.py

### Phase 2: Market Environment Analysis
The system analyzes current market conditions to determine strategy preferences:

**Market Condition Matrix:**
```
Direction (3) × VIX Level (3) = 9 Possible States
- Bullish + Low VIX    → Prefer: Bull spreads, Long calls
- Bullish + Normal VIX → Prefer: Bull spreads, Iron condors
- Bullish + High VIX   → Prefer: Cash-secured puts, Short strangles
- Neutral + Low VIX    → Prefer: Iron condors, Butterflies
- Neutral + Normal VIX → Prefer: Iron condors, Calendar spreads
- Neutral + High VIX   → Prefer: Short straddles, Iron butterflies
- Bearish + Low VIX    → Prefer: Bear spreads, Long puts
- Bearish + Normal VIX → Prefer: Bear spreads, Iron condors
- Bearish + High VIX   → Prefer: Covered calls, Short strangles
```

### Phase 3: Industry Prioritization
Industries are ranked by allocation weight from the database:

**Example Industry Rankings:**
```
1. Electronic Equipment/Instruments: 14.6% (LONG + Strong Overweight)
2. Oil Refining/Marketing: 11.5% (LONG + Strong Overweight)  
3. Packaged Software: 10.8% (LONG + Moderate Overweight)
4. Motor Vehicles: 10.0% (LONG + Neutral)
5. Consumer Services: 9.2% (SHORT + Underweight)
```

### Phase 4: Symbol Selection Within Industries
For each priority industry, the system:

1. **Maps Symbols to Industries** - Uses stock_data table
2. **Filters FNO-Enabled Symbols** - Only tradeable options
3. **Selects Top Symbols** - Based on market cap or liquidity

**Example for Oil Refining/Marketing (11.5%):**
```
Available Symbols: RELIANCE, BPCL, OIL, IOC, HINDPETRO
FNO-Enabled: RELIANCE, BPCL, OIL, IOC  
Selected: RELIANCE, BPCL, OIL (top 3 by market cap)
```

### Phase 5: Strategy Selection Logic
For each selected symbol, the allocator:

1. **Queries Available Strategies** - From main.py analysis
2. **Applies Market Filters** - Based on current conditions
3. **Selects Best Strategy** - Highest total_score

**Example for RELIANCE in Neutral+Normal VIX market:**
```
Available Strategies:
- Iron Condor (Score: 0.742, Matches: Neutral market ✓)
- Diagonal Spread (Score: 0.689, Matches: Normal VIX ✓)
- Bull Call Spread (Score: 0.634, Matches: Bullish bias ✗)
- Cash-Secured Put (Score: 0.598, Matches: Any ✓)

Selected: Iron Condor (0.742) - Best score + market match
```

### Phase 6: Priority Calculation
Each selected strategy gets an execution priority:

**Priority Formula:**
```
Priority = (Industry_Weight × 1000) + (Strategy_Score × 100) + Order_Sequence

Example:
RELIANCE Iron Condor:
Priority = (11.5 × 1000) + (0.742 × 100) + 1
Priority = 11500 + 74.2 + 1 = 11575
```

### Phase 7: Database Updates
The allocator marks strategies for execution:

1. **Clear Previous Marks** - Reset all marked_for_execution = false
2. **Mark Selected Strategies** - Set marked_for_execution = true
3. **Set Execution Status** - execution_status = 'marked'
4. **Assign Priorities** - execution_priority = calculated value

## Detailed Examples

### Example 1: Full Allocation Process

**Market Conditions:**
- NIFTY: Neutral (confidence: 72%)
- VIX: Normal (13.67)
- PCR: 0.91 (neutral sentiment)
- Combined: Neutral_Normal_VIX

**Industry Allocation Table:**
```
Industry                          Weight   Position   Rating
Electronic Equipment/Instruments   14.6%    LONG      Strong Overweight
Oil Refining/Marketing            11.5%    LONG      Strong Overweight
Packaged Software                 10.8%    LONG      Moderate Overweight
Motor Vehicles                    10.0%    LONG      Neutral
Banking                           8.5%     SHORT     Underweight
```

**Step-by-Step Selection:**

**Industry 1: Electronic Equipment/Instruments (14.6%)**
```
Symbol Search: Query stock_data WHERE industry = 'Electronic Equipment/Instruments'
Result: HPL, SPECTRUM, POWERINDIA, HONAUT, WEL
FNO Filter: Query WHERE fno_stock = 'yes'
Result: [] (No FNO-enabled symbols found)
Action: Skip this industry
```

**Industry 2: Oil Refining/Marketing (11.5%)**
```
Symbol Search: RELIANCE, BPCL, OIL, IOC, HINDPETRO
FNO Filter: RELIANCE, BPCL, OIL, IOC (4 symbols)
Selected: RELIANCE, BPCL, OIL (top 3)

For RELIANCE:
Available Strategies: 3 (Diagonal Spread, Bull Call, Cash-Secured Put)
Market Preference: Neutral strategies (Iron Condor, Diagonal)
Best Match: Diagonal Spread (Score: 0.689)
Priority: (11.5 × 1000) + (0.689 × 100) + 1 = 11569

For BPCL:
Available Strategies: 2 (Butterfly Spread, Cash-Secured Put)  
Best Match: Butterfly Spread (Score: 0.806)
Priority: (11.5 × 1000) + (0.806 × 100) + 2 = 11581

For OIL:
Available Strategies: 3 (Diagonal Spread, Bull Call, Cash-Secured Put)
Best Match: Diagonal Spread (Score: 0.666)
Priority: (11.5 × 1000) + (0.666 × 100) + 3 = 11569
```

**Industry 3: Packaged Software (10.8%)**
```
Symbol Search: KPITTECH, BSOFT, INFY, TCS, WIPRO
FNO Filter: KPITTECH, BSOFT, INFY, TCS (4 symbols)
Selected: KPITTECH, BSOFT (top 2)

For KPITTECH:
Available Strategies: 3 (Diagonal Spread, Bull Put, Cash-Secured Put)
Best Match: Diagonal Spread (Score: 0.470)
Priority: (10.8 × 1000) + (0.470 × 100) + 1 = 10847

For BSOFT:
Available Strategies: 3 (Cash-Secured Put, Bull Put, Iron Condor)
Best Match: Cash-Secured Put (Score: 0.496)
Priority: (10.8 × 1000) + (0.496 × 100) + 2 = 10850
```

**Final Selection Results:**
```
Priority Order (Highest First):
1. BPCL - Butterfly Spread (Priority: 11581, Score: 0.806)
2. RELIANCE - Diagonal Spread (Priority: 11569, Score: 0.689)
3. OIL - Diagonal Spread (Priority: 11569, Score: 0.666)
4. BSOFT - Cash-Secured Put (Priority: 10850, Score: 0.496)
5. KPITTECH - Diagonal Spread (Priority: 10847, Score: 0.470)
```

### Example 2: Why Count is Low

**Current Issue Analysis:**

**Expected: 15+ strategies**
**Actual: 7 strategies**

**Root Causes:**

1. **Missing Industry Symbols:**
   ```
   Electronic Equipment/Instruments (14.6% weight) → 0 strategies
   Reason: No FNO-enabled symbols found
   Impact: Losing highest-weight industry
   ```

2. **Limited Symbol Selection:**
   ```
   Per Industry: Only top 2-3 symbols selected
   Per Symbol: Only 1 strategy selected (best score)
   Total: 4 industries × 2.5 symbols × 1 strategy = 10 max
   ```

3. **Strategy Availability:**
   ```
   Some symbols have no strategies in database:
   M&M: No strategies found
   TRENT: Missing from recent run
   ABFRL: Not in symbol list
   ```

4. **Strict Filtering:**
   ```
   Current Logic: Best strategy per symbol only
   Alternative: Could select top 2-3 strategies per symbol
   Impact: Would increase from 7 to 15+ strategies
   ```

## Configuration Parameters

### Current Settings
```
Max Industries: Unlimited (processes all with weight ≥ 5%)
Symbols per Industry: 3
Strategies per Symbol: 1
Minimum Score Threshold: None
Market Condition Filtering: Enabled
```

### Proposed Settings for More Strategies
```
Max Industries: 10
Symbols per Industry: 5
Strategies per Symbol: 2-3
Minimum Score Threshold: 0.4
Market Condition Filtering: Relaxed
Minimum Total Strategies: 15
```

## Flow Diagram

```
Start
  ↓
Load Industry Allocations (27 industries)
  ↓
Filter by Weight ≥ 5% (15 industries)
  ↓
Analyze Market Conditions (Neutral_Normal_VIX)
  ↓
For Each Priority Industry:
  ↓
  Find FNO-Enabled Symbols
  ↓
  Select Top 2-3 Symbols
  ↓
  For Each Symbol:
    ↓
    Query Available Strategies
    ↓
    Filter by Market Preferences
    ↓
    Select Best Strategy
    ↓
    Calculate Priority Score
    ↓
    Mark for Execution
  ↓
Continue Until All Industries Processed
  ↓
Update Database with Marked Strategies
  ↓
End (7 strategies marked)
```

## Performance Metrics

### Current Performance
```
Input: 435 strategies across 150+ symbols
Processing Time: ~30 seconds
Output: 7 strategies marked
Efficiency: 1.6% selection rate
Industries Covered: 4 out of 27
```

### Target Performance
```
Input: 435 strategies across 150+ symbols
Processing Time: ~45 seconds
Output: 15-20 strategies marked
Efficiency: 4-5% selection rate
Industries Covered: 6-8 out of 27
```

## Integration Points

### Input Sources
1. **main.py** → Generates strategies in database
2. **industry_allocations_current** → Industry weights
3. **stock_data** → Symbol-industry mappings
4. **market conditions** → NIFTY + VIX + PCR analysis

### Output Targets
1. **strategies table** → marked_for_execution = true
2. **execution_priority** → Priority ordering
3. **mark_for_execution.py** → Manual review interface
4. **options_v4_executor.py** → Execution engine

## Troubleshooting Guide

### Issue: Too Few Strategies Selected
**Symptoms:** Getting 5-10 instead of 15-20
**Causes:**
- Missing industry mappings
- FNO symbol availability
- Strict filtering criteria
**Solutions:**
- Expand symbol selection per industry
- Allow multiple strategies per symbol
- Relax market condition filters

### Issue: Wrong Strategy Types
**Symptoms:** Getting income strategies in volatile markets
**Causes:**
- Market condition detection error
- Strategy preference mapping
**Solutions:**
- Verify NIFTY + VIX + PCR analysis
- Check strategy metadata scoring

### Issue: Execution Priority Problems
**Symptoms:** Wrong order in execution queue
**Causes:**
- Priority calculation formula
- Industry weight values
**Solutions:**
- Verify industry_allocations_current table
- Check priority formula calculation

This documentation provides a complete understanding of how the portfolio allocator works, its current limitations, and areas for improvement.